<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>회원 운동 기록 시스템</title>
  <style>
    body {
      font-family: Arial, "맑은 고딕", sans-serif;
      max-width: 1100px;
      margin: 20px auto;
      background: #f3f4f6;
      color: #111827;
    }
    h1 {
      margin-bottom: 10px;
      font-size: 24px;
      color: #111827;
    }
    h2 {
      margin-top: 30px;
      font-size: 20px;
      color: #111827;
    }
    h4 {
      margin: 8px 0;
    }
    .box {
      border: 1px solid #e5e7eb;
      padding: 12px 16px;
      margin-bottom: 12px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    label {
      display: inline-block;
      margin: 5px 10px 5px 0;
      font-size: 13px;
    }
    input[type="text"], select, input[type="number"], input[type="date"], input[type="file"] {
      padding: 5px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.2);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 8px;
      background: #fff;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 5px;
      text-align: center;
      font-size: 12px;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
    }
    button {
      padding: 6px 12px;
      margin: 4px 4px 4px 0;
      cursor: pointer;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      font-weight: 500;
    }
    .btn-primary { background: #2563eb; color: #ffffff; }
    .btn-primary:hover { background: #1d4ed8; }

    .btn-success { background: #16a34a; color: #ffffff; }
    .btn-success:hover { background: #15803d; }

    .btn-warning { background: #f97316; color: #ffffff; }
    .btn-warning:hover { background: #ea580c; }

    .btn-danger { background: #dc2626; color: #ffffff; }
    .btn-danger:hover { background: #b91c1c; }

    .btn-gray { background: #6b7280; color: #ffffff; }
    .btn-gray:hover { background: #4b5563; }

    .btn-purple { background: #7c3aed; color: #ffffff; }
    .btn-purple:hover { background: #6d28d9; }

    .set-row input {
      width: 80px;
      text-align: center;
    }
    .small { font-size: 11px; color: #6b7280; }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      background: #e5e7eb;
      margin-right: 4px;
      margin-bottom: 2px;
    }
    .last-hint {
      font-size: 11px;
      color: #374151;
      margin-top: 4px;
      min-height: 14px;
    }
    .member-tag-mini {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e0f2fe;
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #111827;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-content {
      background: #ffffff;
      padding: 16px;
      border-radius: 8px;
      max-width: 900px;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    /* 대시보드 스타일 */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 8px;
      margin-top: 6px;
      margin-bottom: 6px;
    }
    .dashboard-card {
      border-radius: 8px;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 12px;
    }
    .dashboard-card strong {
      font-size: 13px;
    }
    .volume-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      font-size: 11px;
    }
    .volume-bar-container {
      flex: 1;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      height: 8px;
    }
    .volume-bar {
      height: 8px;
      border-radius: 999px;
      background: #2563eb;
    }

    @media print {
      body { background: #ffffff; }
      body * { visibility: hidden; }
      #groupPrintArea, #groupPrintArea * {
        visibility: visible;
      }
      #groupPrintArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>회원 운동 기록 시스템</h1>

  <!-- 0. 회원 등록 / 관리 -->
  <div class="box">
    <div class="section-title">0. 회원 등록 / 관리</div>
    <div style="margin-bottom:6px;">
      <label>이름:
        <input type="text" id="regName" placeholder="예: 홍길동" />
      </label>
      <label>성별:
        <select id="regGender">
          <option value="">선택</option>
          <option value="남">남</option>
          <option value="여">여</option>
        </select>
      </label>
      <label>키(cm):
        <input type="number" id="regHeight" placeholder="예: 170" />
      </label>
      <label>생년월일:
        <input type="date" id="regBirth" />
      </label>
      <label>전화번호:
        <input type="text" id="regPhone" placeholder="예: 010-1234-5678" />
      </label>
      <button id="registerMemberBtn" class="btn-primary">회원 등록</button>
      <span class="small">※ 이름/성별/키/생년월일/전화번호를 등록합니다.</span>
    </div>
    <button id="openMembersModalBtn" class="btn-gray">전체 회원 목록 보기</button>
    <span class="small">※ 회원 수가 많아도 화면이 길어지지 않도록 별도 창에서 확인합니다.</span>
  </div>

  <!-- 1. 운동 기록 대상 회원 선택 -->
  <div class="box">
    <div class="section-title">1. 운동 기록 대상 회원 선택</div>
    <label>회원 선택:
      <select id="memberSelect">
        <option value="">회원 선택</option>
      </select>
    </label>
    <label>회원 검색:
      <input type="text" id="memberSearchInput" placeholder="이름 또는 전화번호 일부" />
    </label>
    <button id="memberSearchBtn" class="btn-primary">불러오기</button>
    <div id="selectedMemberInfo" class="small" style="margin-top:4px;">
      선택된 회원 정보: 없음
    </div>
  </div>

  <!-- 1-1. 회원 대시보드 (홈 요약) -->
  <div class="box">
    <div class="section-title">1-1. 회원 대시보드 (요약)</div>
    <div id="dashboardSummary" class="small">
      1번에서 회원을 선택하면, 운동량/기록/인바디 추이를 한눈에 볼 수 있습니다.
    </div>
    <div id="dashboardVolume"></div>
    <div id="dashboardInbody"></div>
  </div>

  <!-- 2. 현재 운동 입력 -->
  <div class="box">
    <div class="section-title">2. 현재 운동 입력</div>
    <label>운동 부위:
      <select id="bodyPart">
        <option value="">선택</option>
        <option value="가슴">가슴</option>
        <option value="등">등</option>
        <option value="하체">하체</option>
        <option value="어깨">어깨</option>
        <option value="팔">팔</option>
        <option value="전신">전신</option>
        <option value="코어">코어</option>
        <option value="기타">기타</option>
      </select>
    </label>
    <br/>
    <label>운동 명칭:
      <input type="text" id="exerciseName" placeholder="예: 벤치프레스 / 랫풀다운" />
    </label>
    <label>운동 선택:
      <select id="exercisePreset">
        <option value="">부위 선택 후 운동 선택</option>
      </select>
    </label>
    <div id="lastHint" class="last-hint"></div>

    <h4>세트별 무게 / 횟수</h4>
    <table>
      <thead>
        <tr>
          <th>세트</th>
          <th>무게(kg)</th>
          <th>횟수(회)</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody id="currentSetTbody"></tbody>
    </table>
    <button id="addSetBtn" class="btn-primary">세트 추가</button>
    <button id="resetSetsBtn" class="btn-gray">세트 초기화</button>
    <br />
    <button id="addExerciseBtn" class="btn-success">현재 운동을 오늘 루틴에 추가</button>
    <span class="small">※ 추가 후 다음 운동을 입력하세요.</span>
  </div>

  <!-- 2-1. 운동 드랍다운 관리 -->
  <div class="box">
    <div class="section-title">2-1. 운동 드랍다운 관리 (추가 / 삭제)</div>
    <label>운동 부위:
      <select id="libBodyPart">
        <option value="">선택</option>
        <option value="가슴">가슴</option>
        <option value="등">등</option>
        <option value="하체">하체</option>
        <option value="어깨">어깨</option>
        <option value="팔">팔</option>
        <option value="전신">전신</option>
        <option value="코어">코어</option>
        <option value="기타">기타</option>
      </select>
    </label>
    <br/>
    <label>현재 등록된 운동 목록:
      <select id="libExerciseList" size="5" style="min-width:220px;"></select>
    </label>
    <br/>
    <label>새 운동명:
      <input type="text" id="libNewExercise" placeholder="예: 스미스 데드리프트" />
    </label>
    <button id="libAddBtn" class="btn-primary">운동 추가</button>
    <button id="libDeleteBtn" class="btn-danger">선택 삭제</button>
    <div class="small" style="margin-top:4px;">
      ※ 여기서 추가/삭제한 운동은 2번 영역의 “운동 선택” 드랍다운에도 바로 반영됩니다.<br/>
      ※ 데이터는 브라우저에 저장되어, 다음에 켜도 유지됩니다(같은 PC·브라우저 기준).
    </div>
  </div>

  <!-- 3. 오늘 루틴 목록 -->
  <div class="box">
    <div class="section-title">3. 오늘 추가된 운동 목록</div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>부위</th>
          <th>운동명</th>
          <th>세트 요약</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody id="todayTbody"></tbody>
    </table>
    <button id="saveSessionBtn" class="btn-success">오늘 운동 전체 저장</button>
    <span class="small">※ 선택된 회원의 이름으로 오늘 운동이 저장됩니다.</span>
  </div>

  <!-- 8. 텍스트로 운동 기록 일괄 등록 (로컬 전용) -->
  <div class="box">
    <div class="section-title">8. 텍스트로 운동 기록 일괄 등록 (로컬 전용)</div>
    <span class="small">
      한 줄당 하나의 운동을 아래 형식으로 입력한 뒤,<br/>
      <b>[텍스트 → 오늘 루틴 반영]</b> 버튼을 누르면 3번 “오늘 추가된 운동 목록”에 자동으로 들어갑니다.<br/>
      예시)<br/>
      가슴 / 벤치프레스 / 60x10; 60x8; 50x12<br/>
      등 / 랫풀다운 / 40x12; 40x10; 35x12
    </span>
    <textarea id="bulkTextInput" rows="6"
      style="width:100%; margin-top:6px; font-size:12px; font-family:monospace;"></textarea>
    <div style="margin-top:6px;">
      <button id="bulkTextApplyBtn" class="btn-success">텍스트 → 오늘 루틴 반영</button>
      <button id="bulkTextClearBtn" class="btn-gray">텍스트 지우기</button>
    </div>
    <div class="small" style="margin-top:4px;">
      • 형식: <b>부위 / 운동명 / 무게x횟수; 무게x횟수; …</b><br/>
      • 부위는 현재 드랍다운에 있는 이름(가슴, 등, 하체, 어깨, 팔, 전신, 코어, 기타) 기준으로 인식합니다.<br/>
      • 운동명이 해당 부위 운동 라이브러리에 없으면  
        2-1. 운동 드랍다운 관리에 <b>자동으로 추가</b>됩니다.
    </div>
  </div>

  <!-- 4. 4인 그룹 운동표 (A4 인쇄용) -->
  <div class="box" id="groupPrintArea">
    <div class="section-title">4. 4인 그룹 운동표 생성 (저장 회원 기반 + 레벨 표시 + A4 인쇄)</div>
    <label>그룹용 회원 선택:
      <select id="groupMemberSelect">
        <option value="">회원 선택</option>
      </select>
    </label>
    <button id="addGroupMemberBtn" class="btn-primary">그룹에 추가</button>
    <span class="small">※ 저장된 회원만 선택 가능, 최대 4명</span>
    <div id="groupMemberTags" style="margin-top:6px;"></div>

    <button id="generateGroupTableBtn" class="btn-purple">오늘 루틴으로 4인 운동표 생성</button>
    <button id="printGroupBtn" class="btn-warning">그룹운동표 인쇄(PDF)</button>
    <span class="small">
      ※ 인쇄 시 이 영역만 A4 한 페이지에 맞춰 출력됩니다.<br/>
      ※ 브라우저 인쇄 창에서 “PDF로 저장”을 선택하면 PDF 파일로 저장 가능합니다.
    </span>

    <table id="groupTable" style="margin-top:10px;">
      <thead id="groupTableHead"></thead>
      <tbody id="groupTableTbody"></tbody>
    </table>
    <span class="small">
      ※ 각 회원 이름 옆에 [레벨]은 지금까지 저장된 운동 횟수를 기준으로 자동 판단됩니다.<br/>
      ※ 무게 입력칸의 placeholder는 해당 운동에 대한 과거 무게를 참고해서 보여줍니다(있을 경우).
    </span>
  </div>

  <!-- 5. 저장된 기록 조회 + CSV + 백업/복구 -->
  <h2>저장된 운동 기록 (회원별 / 일자별 조회 & 엑셀/백업)</h2>
  <div class="box">
    <div style="margin-bottom:6px;">
      <label>회원 선택:
        <select id="searchMemberSelect">
          <option value="">전체 회원</option>
        </select>
      </label>
      <label>시작일:
        <input type="date" id="dateFrom" />
      </label>
      <label>종료일:
        <input type="date" id="dateTo" />
      </label>
    </div>
    <button id="filterBtn" class="btn-primary">검색</button>
    <button id="resetFilterBtn" class="btn-gray">필터 초기화</button>
    <button id="exportCsvBtn" class="btn-warning">엑셀(DB)용 CSV 다운로드</button>
    <br />
    <span class="small">
      ※ CSV는 엑셀에서 바로 열 수 있는 형식입니다.<br/>
      ※ 구조: 날짜시간, 회원ID, 이름, 부위, 운동명, 세트번호, 무게(kg), 횟수(회)
    </span>
  </div>

  <table>
    <thead>
      <tr>
        <th>날짜/시간</th>
        <th>회원</th>
        <th>운동 루틴 요약</th>
      </tr>
    </thead>
    <tbody id="sessionsTbody"></tbody>
  </table>

  <!-- 6. 백업/복구 -->
  <div class="box">
    <div class="section-title">6. 데이터 백업 / 복구</div>
    <button id="backupJsonBtn" class="btn-primary">JSON 백업 내보내기</button>
    <label style="margin-left:10px;">
      JSON 백업 불러오기:
      <input type="file" id="restoreJsonInput" accept="application/json" />
    </label>
    <div id="backupInfo" class="small" style="margin-top:6px;">
      최근 자동 백업: 없음
    </div>

    <div style="margin-top:6px;">
      <label>
        <input type="checkbox" id="autoDownloadBackupToggle" />
        창을 닫을 때 자동으로 JSON 백업 파일 다운로드
      </label>
      <span class="small">※ PC 다운로드 폴더에 날짜/시간별로 저장됩니다.</span>
    </div>

    <span class="small">
      ※ “JSON 백업 내보내기”는 파일로 저장되는 수동 백업입니다.<br/>
      ※ 프로그램을 끌 때마다 내부 자동백업도 함께 갱신됩니다(브라우저 localStorage 기준).
    </span>
  </div>

  <!-- 7. 인바디 기록 관리 -->
  <div class="box">
    <div class="section-title">7. 인바디 기록 관리 (회원별 인바디 추이)</div>
    <div style="margin-bottom:6px;">
      <label>대상 회원:
        <select id="inbodyMemberSelect">
          <option value="">회원 선택</option>
        </select>
      </label>
    </div>
    <div style="margin-bottom:6px;">
      <label>기록일:
        <input type="date" id="inbodyDate" />
      </label>
      <label>체중(kg):
        <input type="number" step="0.1" id="inbodyWeight" />
      </label>
      <label>골격근량(kg):
        <input type="number" step="0.1" id="inbodyMuscle" />
      </label>
      <label>체지방률(%):
        <input type="number" step="0.1" id="inbodyFatPercent" />
      </label>
      <label>체지방량(kg):
        <input type="number" step="0.1" id="inbodyFatMass" />
      </label>
      <label>메모:
        <input type="text" id="inbodyMemo" placeholder="예: 오전 측정, 공복 등" />
      </label>
      <button id="addInbodyBtn" class="btn-success">인바디 기록 추가</button>
    </div>
    <div style="margin-bottom:6px;">
      <label>CSV 업로드:
        <input type="file" id="inbodyFileInput" accept=".csv,text/csv" />
      </label>
      <span class="small">
        형식: 날짜,체중,골격근량,체지방률,체지방량<br/>
        예) 2025-11-28,70.3,32.1,18.5,13.0
      </span>
    </div>
    <table>
      <thead>
        <tr>
          <th>날짜</th>
          <th>체중</th>
          <th>골격근량</th>
          <th>체지방률</th>
          <th>체지방량</th>
          <th>메모</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody id="inbodyTbody"></tbody>
    </table>
    <span class="small">
      ※ 인바디 기계에서 CSV로 뽑은 파일을 이 형식으로 맞추면 업로드로 한 번에 입력 가능합니다.<br/>
      ※ 이미지(PDF 출력지) 자체를 자동 인식하는 기능은 별도 서버/AI가 필요해서, 현재 버전에서는 지원하지 않습니다.
    </span>
  </div>

  <!-- 전체 회원 모달 -->
  <div id="membersModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <span class="section-title">전체 회원 목록</span>
        <button id="closeMembersModalBtn" class="btn-gray">닫기</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>이름</th>
            <th>성별</th>
            <th>키</th>
            <th>생년월일</th>
            <th>전화번호</th>
            <th>삭제</th>
          </tr>
        </thead>
        <tbody id="membersTbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ====== 상수 및 기본값 ======
    const STORAGE_SESSIONS_KEY   = "workoutSessions_v4";
    const STORAGE_MEMBERS_KEY    = "members_v2";
    const STORAGE_AUTOBACKUP_KEY = "workoutAutoBackup_v1";
    const STORAGE_AUTO_DL_KEY    = "autoDownloadBackupEnabled_v1";
    const STORAGE_EXLIB_KEY      = "exerciseLibrary_v1";
    const STORAGE_INBODY_KEY     = "inbodyRecords_v1";

    // 기본 운동 라이브러리
    const DEFAULT_EXERCISE_LIBRARY = {
      "가슴": ["벤치프레스","인클라인 벤치프레스","덤벨 벤치프레스","덤벨 플라이","인클라인 덤벨 플라이","펙덱 플라이","체스트 프레스 머신","푸시업"],
      "등": ["랫풀다운","시티드 로우","바벨 로우","덤벨 로우","케이블 로우","풀업","친업","티바 로우"],
      "하체": ["스쿼트","레그프레스","런지","레그 익스텐션","레그 컬","불가리안 스플릿 스쿼트","히프 쓰러스트","스티프 데드리프트"],
      "어깨": ["숄더 프레스","덤벨 숄더 프레스","사이드 레터럴 레이즈","프론트 레이즈","리어 델트 플라이","페이스 풀","업라이트 로우"],
      "팔": ["바벨 컬","덤벨 컬","해머 컬","케이블 푸시다운","트라이셉스 익스텐션","딥스","오버헤드 트라이셉스 익스텐션"],
      "전신": ["데드리프트","클린","스내치","버피","케틀벨 스윙"],
      "코어": ["플랭크","크런치","레그 레이즈","행잉 레그 레이즈","케이블 크런치","러시안 트위스트"],
      "기타": ["워킹 런지","파머스 워크","슬레드 푸시"]
    };

    let exerciseLibrary = {};

    function loadExerciseLibrary() {
      const raw = localStorage.getItem(STORAGE_EXLIB_KEY);
      if (!raw) {
        exerciseLibrary = JSON.parse(JSON.stringify(DEFAULT_EXERCISE_LIBRARY));
        saveExerciseLibrary();
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        const base = JSON.parse(JSON.stringify(DEFAULT_EXERCISE_LIBRARY));
        exerciseLibrary = { ...base, ...parsed };
        Object.keys(base).forEach(part => {
          if (!Array.isArray(exerciseLibrary[part])) {
            exerciseLibrary[part] = base[part];
          }
        });
      } catch {
        exerciseLibrary = JSON.parse(JSON.stringify(DEFAULT_EXERCISE_LIBRARY));
        saveExerciseLibrary();
      }
    }
    function saveExerciseLibrary() {
      localStorage.setItem(STORAGE_EXLIB_KEY, JSON.stringify(exerciseLibrary));
    }

    // 이전 버전 키 마이그레이션
    (function migrateOldData() {
      try {
        if (!localStorage.getItem(STORAGE_SESSIONS_KEY)) {
          const oldSessionKeys = ["workoutSessions_v3", "workoutSessions_v2", "workoutSessions_v1"];
          for (const k of oldSessionKeys) {
            const raw = localStorage.getItem(k);
            if (raw) {
              localStorage.setItem(STORAGE_SESSIONS_KEY, raw);
              break;
            }
          }
        }
        if (!localStorage.getItem(STORAGE_MEMBERS_KEY)) {
          const oldMemberKeys = ["members_v1"];
          for (const k of oldMemberKeys) {
            const raw = localStorage.getItem(k);
            if (raw) {
              localStorage.setItem(STORAGE_MEMBERS_KEY, raw);
              break;
            }
          }
        }
      } catch (e) {
        console.error("migration error", e);
      }
    })();

    // 운동 라이브러리 로드
    loadExerciseLibrary();

    // ====== DOM 참조 ======
    const regNameInput    = document.getElementById("regName");
    const regGenderInput  = document.getElementById("regGender");
    const regHeightInput  = document.getElementById("regHeight");
    const regBirthInput   = document.getElementById("regBirth");
    const regPhoneInput   = document.getElementById("regPhone");
    const registerMemberBtn = document.getElementById("registerMemberBtn");
    const openMembersModalBtn = document.getElementById("openMembersModalBtn");
    const membersModal    = document.getElementById("membersModal");
    const closeMembersModalBtn = document.getElementById("closeMembersModalBtn");
    const membersTbody    = document.getElementById("membersTbody");

    const memberSelect    = document.getElementById("memberSelect");
    const memberSearchInput = document.getElementById("memberSearchInput");
    const memberSearchBtn = document.getElementById("memberSearchBtn");
    const selectedMemberInfo = document.getElementById("selectedMemberInfo");

    const dashboardSummaryDiv = document.getElementById("dashboardSummary");
    const dashboardVolumeDiv  = document.getElementById("dashboardVolume");
    const dashboardInbodyDiv  = document.getElementById("dashboardInbody");

    const bodyPartSelect  = document.getElementById("bodyPart");
    const exerciseNameInput = document.getElementById("exerciseName");
    const exercisePresetSelect = document.getElementById("exercisePreset");
    const lastHintDiv     = document.getElementById("lastHint");
    const currentSetTbody = document.getElementById("currentSetTbody");
    const addSetBtn       = document.getElementById("addSetBtn");
    const resetSetsBtn    = document.getElementById("resetSetsBtn");
    const addExerciseBtn  = document.getElementById("addExerciseBtn");
    const todayTbody      = document.getElementById("todayTbody");
    const saveSessionBtn  = document.getElementById("saveSessionBtn");

    const libBodyPartSelect  = document.getElementById("libBodyPart");
    const libExerciseList    = document.getElementById("libExerciseList");
    const libNewExerciseInput= document.getElementById("libNewExercise");
    const libAddBtn          = document.getElementById("libAddBtn");
    const libDeleteBtn       = document.getElementById("libDeleteBtn");

    const groupMemberSelect = document.getElementById("groupMemberSelect");
    const addGroupMemberBtn = document.getElementById("addGroupMemberBtn");
    const groupMemberTags   = document.getElementById("groupMemberTags");
    const generateGroupTableBtn = document.getElementById("generateGroupTableBtn");
    const printGroupBtn     = document.getElementById("printGroupBtn");
    const groupTableHead    = document.getElementById("groupTableHead");
    const groupTableTbody   = document.getElementById("groupTableTbody");

    const searchMemberSelect = document.getElementById("searchMemberSelect");
    const dateFromInput    = document.getElementById("dateFrom");
    const dateToInput      = document.getElementById("dateTo");
    const filterBtn        = document.getElementById("filterBtn");
    const resetFilterBtn   = document.getElementById("resetFilterBtn");
    const exportCsvBtn     = document.getElementById("exportCsvBtn");
    const sessionsTbody    = document.getElementById("sessionsTbody");

    // 8. 텍스트 일괄 등록용
    const bulkTextInput      = document.getElementById("bulkTextInput");
    const bulkTextApplyBtn   = document.getElementById("bulkTextApplyBtn");
    const bulkTextClearBtn   = document.getElementById("bulkTextClearBtn");

    const backupJsonBtn    = document.getElementById("backupJsonBtn");
    const restoreJsonInput = document.getElementById("restoreJsonInput");
    const backupInfo       = document.getElementById("backupInfo");
    const autoDownloadBackupToggle = document.getElementById("autoDownloadBackupToggle");

    const inbodyMemberSelect = document.getElementById("inbodyMemberSelect");
    const inbodyDateInput    = document.getElementById("inbodyDate");
    const inbodyWeightInput  = document.getElementById("inbodyWeight");
    const inbodyMuscleInput  = document.getElementById("inbodyMuscle");
    const inbodyFatPercentInput = document.getElementById("inbodyFatPercent");
    const inbodyFatMassInput = document.getElementById("inbodyFatMass");
    const inbodyMemoInput    = document.getElementById("inbodyMemo");
    const addInbodyBtn       = document.getElementById("addInbodyBtn");
    const inbodyFileInput    = document.getElementById("inbodyFileInput");
    const inbodyTbody        = document.getElementById("inbodyTbody");

    let todayExercises = [];
    let groupMembers   = [];

    // ====== localStorage 헬퍼 ======
    function loadSessions() {
      const raw = localStorage.getItem(STORAGE_SESSIONS_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }
    function saveSessions(sessions) {
      localStorage.setItem(STORAGE_SESSIONS_KEY, JSON.stringify(sessions));
    }

    function loadMembers() {
      const raw = localStorage.getItem(STORAGE_MEMBERS_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }
    function saveMembers(members) {
      localStorage.setItem(STORAGE_MEMBERS_KEY, JSON.stringify(members));
    }

    function loadInbody() {
      const raw = localStorage.getItem(STORAGE_INBODY_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }
    function saveInbody(records) {
      localStorage.setItem(STORAGE_INBODY_KEY, JSON.stringify(records));
    }

    // ====== 백업 관련 ======
    function createBackupData() {
      return {
        createdAt: Date.now(),
        members: loadMembers(),
        sessions: loadSessions(),
        inbody: loadInbody(),
        exerciseLibrary
      };
    }

    function formatDateTime(ts) {
      const d = new Date(ts);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
    }

    function updateBackupInfo() {
      const raw = localStorage.getItem(STORAGE_AUTOBACKUP_KEY);
      if (!raw) {
        backupInfo.textContent = "최근 자동 백업: 없음";
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        if (parsed && parsed.time) {
          backupInfo.textContent = `최근 자동 백업: ${formatDateTime(parsed.time)} (브라우저 내부)`;
        } else {
          backupInfo.textContent = "최근 자동 백업: 정보 없음";
        }
      } catch {
        backupInfo.textContent = "최근 자동 백업: 정보 없음";
      }
    }

    function saveAutoBackup() {
      try {
        const backup = {
          time: Date.now(),
          data: createBackupData()
        };
        localStorage.setItem(STORAGE_AUTOBACKUP_KEY, JSON.stringify(backup));
        updateBackupInfo();
      } catch (e) {
        console.error("auto backup failed", e);
      }
    }

    function exportJsonBackup() {
      const backup = createBackupData();
      const BOM = "\uFEFF";
      const blob = new Blob([BOM + JSON.stringify(backup, null, 2)], {type:"application/json;charset=utf-8;"});
      const url  = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const now  = new Date();
      const yyyymmdd = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}`;
      const hh = String(now.getHours()).padStart(2,"0");
      const mi = String(now.getMinutes()).padStart(2,"0");
      link.href = url;
      link.download = `workout_backup_${yyyymmdd}_${hh}${mi}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function restoreFromJsonFile(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const parsed = JSON.parse(text);
          if (!parsed || typeof parsed !== "object") {
            alert("올바른 JSON 백업 파일이 아닙니다.");
            return;
          }
          const members = Array.isArray(parsed.members) ? parsed.members : [];
          const sessions = Array.isArray(parsed.sessions) ? parsed.sessions : [];
          const inbody = Array.isArray(parsed.inbody) ? parsed.inbody : [];
          const exLib = parsed.exerciseLibrary || null;

          saveMembers(members);
          saveSessions(sessions);
          saveInbody(inbody);
          if (exLib) {
            exerciseLibrary = exLib;
            saveExerciseLibrary();
          } else {
            loadExerciseLibrary();
          }

          saveAutoBackup();
          renderMembersTable();
          renderMemberSelectOptions();
          renderSessions();
          renderInbodyForMember(inbodyMemberSelect.value || memberSelect.value || "");
          renderDashboard();
          alert("백업 파일에서 데이터가 복구되었습니다.");
        } catch (err) {
          console.error(err);
          alert("백업 파일을 읽는 중 오류가 발생했습니다.");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function triggerDownloadAutoBackup() {
      const backup = createBackupData();
      const jsonStr = JSON.stringify(backup, null, 2);
      const BOM = "\uFEFF";
      const blob = new Blob([BOM + jsonStr], {
        type: "application/json;charset=utf-8;"
      });

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm   = String(now.getMonth() + 1).padStart(2, "0");
      const dd   = String(now.getDate(), 10).padStart(2, "0");
      const hh   = String(now.getHours(), 10).padStart(2, "0");
      const mi   = String(now.getMinutes(), 10).padStart(2, "0");

      const fileName = `workout_auto_backup_${yyyy}-${mm}-${dd}_${hh}${mi}.json`;

      const url = URL.createObjectURL(blob);
      const a   = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function loadAutoDownloadSetting() {
      try {
        const raw = localStorage.getItem(STORAGE_AUTO_DL_KEY);
        if (!raw) return false;
        return raw === "1";
      } catch {
        return false;
      }
    }
    function saveAutoDownloadSetting(enabled) {
      try {
        localStorage.setItem(STORAGE_AUTO_DL_KEY, enabled ? "1" : "0");
      } catch (e) {
        console.error("failed to save autoDownload setting", e);
      }
    }
    function initAutoDownloadToggle() {
      if (!autoDownloadBackupToggle) return;
      const enabled = loadAutoDownloadSetting();
      autoDownloadBackupToggle.checked = enabled;
      autoDownloadBackupToggle.addEventListener("change", () => {
        saveAutoDownloadSetting(autoDownloadBackupToggle.checked);
      });
    }

    backupJsonBtn.addEventListener("click", exportJsonBackup);
    restoreJsonInput.addEventListener("change", () => {
      const file = restoreJsonInput.files[0];
      if (!file) return;
      if (!confirm("선택한 백업 파일로 현재 데이터를 덮어쓸까요?")) {
        restoreJsonInput.value = "";
        return;
      }
      restoreFromJsonFile(file);
      restoreJsonInput.value = "";
    });

    // 창 닫을 때: 내부 자동백업 + 토글 ON이면 파일 자동 다운로드
    window.addEventListener("beforeunload", (e) => {
      // 1) 먼저 내부 자동 백업(localStorage)에 한 번 더 저장
      saveAutoBackup();

      // 2) 자동 다운로드 백업 토글이 켜져 있으면, JSON 백업 파일도 다운로드
      const enabled = loadAutoDownloadSetting();
      if (enabled) {
        try {
          triggerDownloadAutoBackup();
        } catch (err) {
          console.error("auto download backup failed", err);
        }
      }

      // 3) 페이지를 닫기 전에 브라우저 기본 확인창 띄우기
      e.preventDefault();
      e.returnValue = "";
    });

    // ====== 회원 관리 ======
    function registerMember() {
      const name   = regNameInput.value.trim();
      const gender = regGenderInput.value;
      const height = regHeightInput.value.trim();
      const birth  = regBirthInput.value;
      const phone  = regPhoneInput.value.trim();

      if (!name) {
        alert("이름을 입력해주세요.");
        return;
      }

      const members = loadMembers();
      const newMember = {
        id: Date.now(),
        name,
        gender,
        height: height ? Number(height) : null,
        birth,
        phone,
        createdAt: Date.now(),
      };
      members.push(newMember);
      saveMembers(members);
      saveAutoBackup();

      regNameInput.value = "";
      regGenderInput.value = "";
      regHeightInput.value = "";
      regBirthInput.value = "";
      regPhoneInput.value = "";

      renderMembersTable();
      renderMemberSelectOptions();
      alert("회원이 등록되었습니다.");
    }

    function deleteMember(id) {
      if (!confirm("정말 이 회원을 삭제하시겠습니까?\n※ 운동 기록/인바디 데이터는 남아 있지만, 회원 목록에서는 제거됩니다.")) return;
      let members = loadMembers();
      members = members.filter(m => String(m.id) !== String(id));
      saveMembers(members);
      saveAutoBackup();

      if (memberSelect.value === String(id)) {
        memberSelect.value = "";
        todayExercises = [];
        renderTodayExercises();
      }
      if (searchMemberSelect.value === String(id)) {
        searchMemberSelect.value = "";
      }
      if (groupMembers.includes(String(id))) {
        groupMembers = groupMembers.filter(mid => mid !== String(id));
        renderGroupMembers();
      }
      if (inbodyMemberSelect.value === String(id)) {
        inbodyMemberSelect.value = "";
        renderInbodyForMember("");
      }

      renderMembersTable();
      renderMemberSelectOptions();
      renderSessions();
      renderDashboard();
    }

    function renderMembersTable() {
      const members = loadMembers().slice().sort((a, b) => a.name.localeCompare(b.name, "ko"));
      membersTbody.innerHTML = "";
      members.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.name}</td>
          <td>${m.gender || "-"}</td>
          <td>${m.height ? m.height + "cm" : "-"}</td>
          <td>${m.birth || "-"}</td>
          <td>${m.phone || "-"}</td>
          <td><button type="button" class="btn-danger deleteMemberBtn" data-id="${m.id}">삭제</button></td>
        `;
        membersTbody.appendChild(tr);
      });

      membersTbody.querySelectorAll(".deleteMemberBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          deleteMember(id);
        });
      });
    }

    function updateInbodyMemberSelectOptions() {
      const members = loadMembers().slice().sort((a, b) => a.name.localeCompare(b.name, "ko"));
      const current = inbodyMemberSelect.value;
      inbodyMemberSelect.innerHTML = `<option value="">회원 선택</option>`;
      members.forEach(m => {
        const option = document.createElement("option");
        option.value = String(m.id);
        option.textContent = `${m.name} (${m.phone || "전화번호 없음"})`;
        inbodyMemberSelect.appendChild(option);
      });
      if (current) inbodyMemberSelect.value = current;
    }

    function renderMemberSelectOptions() {
      const members = loadMembers().slice().sort((a, b) => a.name.localeCompare(b.name, "ko"));

      const currentValue = memberSelect.value;
      memberSelect.innerHTML = `<option value="">회원 선택</option>`;
      members.forEach(m => {
        const option = document.createElement("option");
        option.value = String(m.id);
        option.textContent = `${m.name} (${m.phone || "전화번호 없음"})`;
        memberSelect.appendChild(option);
      });
      if (currentValue) memberSelect.value = currentValue;

      const searchCurrent = searchMemberSelect.value;
      searchMemberSelect.innerHTML = `<option value="">전체 회원</option>`;
      members.forEach(m => {
        const option = document.createElement("option");
        option.value = String(m.id);
        option.textContent = `${m.name} (${m.phone || "전화번호 없음"})`;
        searchMemberSelect.appendChild(option);
      });
      if (searchCurrent) searchMemberSelect.value = searchCurrent;

      const groupCurrent = groupMemberSelect.value;
      groupMemberSelect.innerHTML = `<option value="">회원 선택</option>`;
      members.forEach(m => {
        const option = document.createElement("option");
        option.value = String(m.id);
        option.textContent = `${m.name} (${m.phone || "전화번호 없음"})`;
        groupMemberSelect.appendChild(option);
      });
      if (groupCurrent) groupMemberSelect.value = groupCurrent;

      updateInbodyMemberSelectOptions();
      updateSelectedMemberInfo();
      renderGroupMembers();
    }

    function findMemberById(id) {
      const members = loadMembers();
      return members.find(m => String(m.id) === String(id)) || null;
    }

    function updateSelectedMemberInfo() {
      const memberId = memberSelect.value;
      if (!memberId) {
        selectedMemberInfo.textContent = "선택된 회원 정보: 없음";
        dashboardSummaryDiv.textContent = "1번에서 회원을 선택하면, 운동량/기록/인바디 추이를 한눈에 볼 수 있습니다.";
        dashboardVolumeDiv.innerHTML = "";
        dashboardInbodyDiv.innerHTML = "";
        return;
      }
      const m = findMemberById(memberId);
      if (!m) {
        selectedMemberInfo.textContent = "선택된 회원 정보: (삭제된 회원)";
        return;
      }
      selectedMemberInfo.innerHTML =
        `선택된 회원 정보: <span class="member-tag-mini">${m.name}</span>` +
        `성별: ${m.gender || "-"} / 키: ${m.height ? m.height + "cm" : "-"} / ` +
        `생년월일: ${m.birth || "-"} / 전화번호: ${m.phone || "-"}`;

      // 인바디 선택창이 비어있다면, 현재 회원으로 맞춰주기
      if (!inbodyMemberSelect.value) {
        inbodyMemberSelect.value = String(memberId);
      }
    }

    registerMemberBtn.addEventListener("click", registerMember);

    openMembersModalBtn.addEventListener("click", () => {
      renderMembersTable();
      membersModal.style.display = "flex";
    });
    closeMembersModalBtn.addEventListener("click", () => {
      membersModal.style.display = "none";
    });

    memberSearchBtn.addEventListener("click", () => {
      const q = memberSearchInput.value.trim();
      if (!q) {
        alert("검색할 이름 또는 전화번호 일부를 입력해주세요.");
        return;
      }
      const members = loadMembers();
      const found = members.find(m =>
        (m.name && m.name.includes(q)) ||
        (m.phone && m.phone.includes(q))
      );
      if (!found) {
        alert("일치하는 회원이 없습니다.");
        return;
      }
      memberSelect.value = String(found.id);
      memberSelect.dispatchEvent(new Event("change"));
    });

    memberSelect.addEventListener("change", () => {
      updateSelectedMemberInfo();
      todayExercises = [];
      renderTodayExercises();
      bodyPartSelect.value = "";
      exerciseNameInput.value = "";
      lastHintDiv.textContent = "";
      resetSets();
      populateExercisePreset();
      renderDashboard();
      if (inbodyMemberSelect.value === "") {
        inbodyMemberSelect.value = memberSelect.value;
        renderInbodyForMember(memberSelect.value);
      }
    });

    // ====== 세트 행 관련 ======
    function createSetRow(weight = "", reps = "") {
      const row = document.createElement("tr");
      row.className = "set-row";
      const index = currentSetTbody.children.length + 1;
      row.innerHTML = `
        <td class="set-index">${index}세트</td>
        <td><input type="number" min="0" step="0.5" class="set-weight" value="${weight}" /></td>
        <td><input type="number" min="0" step="1" class="set-reps" value="${reps}" /></td>
        <td><button type="button" class="btn-danger deleteSetBtn">X</button></td>
      `;
      const delBtn = row.querySelector(".deleteSetBtn");
      delBtn.addEventListener("click", () => {
        row.remove();
        refreshSetIndex();
      });
      return row;
    }

    function addSetRow(weight = "", reps = "") {
      const row = createSetRow(weight, reps);
      currentSetTbody.appendChild(row);
    }

    function refreshSetIndex() {
      Array.from(currentSetTbody.children).forEach((row, idx) => {
        const idxCell = row.querySelector(".set-index");
        if (idxCell) idxCell.textContent = (idx + 1) + "세트";
      });
    }

    function resetSets(defaultCount = 3) {
      currentSetTbody.innerHTML = "";
      for (let i = 0; i < defaultCount; i++) {
        addSetRow();
      }
    }

    addSetBtn.addEventListener("click", () => {
      addSetRow();
    });

    resetSetsBtn.addEventListener("click", () => {
      resetSets();
      lastHintDiv.textContent = "";
    });

    // 페이지 로드 시 기본 3세트
    resetSets();

    // ====== 운동 드랍다운 ======
    function populateExercisePreset() {
      const part = bodyPartSelect.value;
      exercisePresetSelect.innerHTML = "";
      const defaultOpt = document.createElement("option");
      defaultOpt.value = "";
      defaultOpt.textContent = part ? "운동 선택" : "부위 선택 후 운동 선택";
      exercisePresetSelect.appendChild(defaultOpt);

      if (!part) return;
      const list = exerciseLibrary[part] || [];
      list.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        exercisePresetSelect.appendChild(opt);
      });
    }

    bodyPartSelect.addEventListener("change", () => {
      populateExercisePreset();
      exerciseNameInput.value = "";
      lastHintDiv.textContent = "";
      resetSets();
    });

    exercisePresetSelect.addEventListener("change", () => {
      const val = exercisePresetSelect.value;
      if (!val) return;
      exerciseNameInput.value = val;
      applySuggestedWeights();
    });

    // 운동 라이브러리 관리 UI
    function renderLibExerciseList() {
      const part = libBodyPartSelect.value;
      libExerciseList.innerHTML = "";
      if (!part) return;
      const list = exerciseLibrary[part] || [];
      list.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        libExerciseList.appendChild(opt);
      });
    }

    libBodyPartSelect.addEventListener("change", () => {
      renderLibExerciseList();
    });

    libAddBtn.addEventListener("click", () => {
      const part = libBodyPartSelect.value;
      const name = libNewExerciseInput.value.trim();
      if (!part) {
        alert("부위를 먼저 선택해주세요.");
        return;
      }
      if (!name) {
        alert("추가할 운동명을 입력해주세요.");
        return;
      }
      if (!exerciseLibrary[part]) {
        exerciseLibrary[part] = [];
      }
      if (exerciseLibrary[part].includes(name)) {
        alert("이미 등록된 운동명입니다.");
        return;
      }
      exerciseLibrary[part].push(name);
      saveExerciseLibrary();
      renderLibExerciseList();
      if (bodyPartSelect.value === part) {
        populateExercisePreset();
      }
      libNewExerciseInput.value = "";
    });

    libDeleteBtn.addEventListener("click", () => {
      const part = libBodyPartSelect.value;
      if (!part) {
        alert("부위를 먼저 선택해주세요.");
        return;
      }
      const selectedOptions = Array.from(libExerciseList.selectedOptions);
      if (selectedOptions.length === 0) {
        alert("삭제할 운동을 선택해주세요.");
        return;
      }
      if (!confirm("선택한 운동명을 삭제하시겠습니까?")) return;
      const namesToDelete = selectedOptions.map(opt => opt.value);
      const list = exerciseLibrary[part] || [];
      exerciseLibrary[part] = list.filter(n => !namesToDelete.includes(n));
      saveExerciseLibrary();
      renderLibExerciseList();
      if (bodyPartSelect.value === part) {
        populateExercisePreset();
      }
    });

    // ====== 지난 기록 기반 자동 무게 추천 ======
    function getLastExerciseHistory(memberId, exerciseName) {
      const sessions = loadSessions().slice().sort((a, b) => b.timestamp - a.timestamp);
      for (const session of sessions) {
        if (String(session.memberId || "") !== String(memberId || "")) continue;
        for (const ex of session.exercises) {
          if (ex.exerciseName === exerciseName) return ex;
        }
      }
      return null;
    }

    function applySuggestedWeights() {
      const memberId = memberSelect.value;
      const exName   = exerciseNameInput.value.trim();
      if (!memberId || !exName) {
        lastHintDiv.textContent = "";
        return;
      }
      const lastEx = getLastExerciseHistory(memberId, exName);
      if (!lastEx) {
        resetSets();
        lastHintDiv.textContent = "이전에 저장된 기록이 없습니다. 처음부터 세트를 입력해주세요.";
        return;
      }
      currentSetTbody.innerHTML = "";
      lastEx.sets.forEach(s => {
        addSetRow(s.weight, "");
      });
      refreshSetIndex();
      const prevText = lastEx.sets
        .map(s => `${s.setNo}세트: ${s.weight}kg x ${s.reps}회`)
        .join(" / ");
      lastHintDiv.textContent = `지난 기록 불러오기 완료: ${prevText}`;
    }

    exerciseNameInput.addEventListener("blur", applySuggestedWeights);

    // ====== 오늘 루틴 관리 ======
    function collectCurrentExercise() {
      const memberId = memberSelect.value;
      if (!memberId) {
        alert("먼저 1번에서 운동할 회원을 선택해주세요.");
        return null;
      }
      const bodyPart = bodyPartSelect.value;
      const exName   = exerciseNameInput.value.trim();
      if (!bodyPart) {
        alert("운동 부위를 선택해주세요.");
        return null;
      }
      if (!exName) {
        alert("운동 명칭을 입력하거나 선택해주세요.");
        return null;
      }

      const setRows = Array.from(currentSetTbody.querySelectorAll("tr.set-row"));
      const sets = [];
      setRows.forEach((row, idx) => {
        const wInput = row.querySelector(".set-weight");
        const rInput = row.querySelector(".set-reps");
        const weight = wInput.value.trim();
        const reps   = rInput.value.trim();
        if (weight || reps) {
          sets.push({
            setNo: idx + 1,
            weight: weight || "0",
            reps: reps || "0"
          });
        }
      });
      if (sets.length === 0) {
        alert("최소 1개 이상의 세트 정보를 입력해주세요.");
        return null;
      }
      return { bodyPart, exerciseName: exName, sets };
    }

    function renderTodayExercises() {
      todayTbody.innerHTML = "";
      todayExercises.forEach((ex, idx) => {
        const tr = document.createElement("tr");
        const setsText = ex.sets
          .map(s => `${s.setNo}세트: ${s.weight}kg x ${s.reps}회`)
          .join("<br />");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${ex.bodyPart}</td>
          <td>${ex.exerciseName}</td>
          <td>${setsText}</td>
          <td><button type="button" class="btn-danger deleteExBtn" data-idx="${idx}">삭제</button></td>
        `;
        todayTbody.appendChild(tr);
      });

      todayTbody.querySelectorAll(".deleteExBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const index = Number(btn.getAttribute("data-idx"));
          todayExercises.splice(index, 1);
          renderTodayExercises();
        });
      });
    }

    // ====== 8. 텍스트 일괄 등록 파서 ======
    // 형식: 부위 / 운동명 / 60x10; 60x8; 50x12
    function parseBulkTextToExercises(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
      const result = [];

      lines.forEach(line => {
        if (!line) return;

        // 부위 / 운동명 / 세트들
        const parts = line.split("/").map(p => p.trim()).filter(p => p);
        if (parts.length < 3) {
          // 형식이 안 맞으면 그냥 건너뜀
          return;
        }

        const bodyPart = parts[0];      // 예: 가슴
        const exerciseName = parts[1];  // 예: 벤치프레스
        const setsRaw = parts.slice(2).join(" / "); // 3번째 이후는 전부 세트 정보로 취급

        // 부위가 라이브러리에 없으면 무시 (오타 방지)
        if (!exerciseLibrary[bodyPart]) {
          return;
        }

        // 운동명이 없으면 라이브러리에 자동 추가
        if (!exerciseLibrary[bodyPart].includes(exerciseName)) {
          exerciseLibrary[bodyPart].push(exerciseName);
          saveExerciseLibrary();

          // 2-1. 운동 드랍다운 관리 화면이 같은 부위를 보고 있으면 새 목록 반영
          if (libBodyPartSelect.value === bodyPart) {
            renderLibExerciseList();
          }
          // 2. 현재 운동 입력 드랍다운이 같은 부위를 보고 있으면 목록 갱신
          if (bodyPartSelect.value === bodyPart) {
            populateExercisePreset();
          }
        }

        // 세트 파싱 (예: "60x10; 60x8; 50x12")
        const setTokens = setsRaw.split(";").map(t => t.trim()).filter(t => t);
        const sets = [];
        let setNo = 1;

        setTokens.forEach(token => {
          // 60x10, 60 X 10, 60*10 등 허용
          const m = token.match(/(\d+(?:\.\d+)?)\s*[xX\*]\s*(\d+)/);
          if (!m) return;
          const weight = m[1];
          const reps = m[2];
          sets.push({
            setNo: setNo++,
            weight,
            reps
          });
        });

        if (sets.length === 0) return;

        result.push({
          bodyPart,
          exerciseName,
          sets
        });
      });

      return result;
    }

    // 텍스트 → 오늘 루틴 반영
    if (bulkTextApplyBtn) {
      bulkTextApplyBtn.addEventListener("click", () => {
        const memberId = memberSelect.value;
        if (!memberId) {
          alert("먼저 1번에서 운동 기록 대상 회원을 선택해주세요.");
          return;
        }
        const text = (bulkTextInput.value || "").trim();
        if (!text) {
          alert("텍스트를 입력해주세요.");
          return;
        }

        const parsedExercises = parseBulkTextToExercises(text);
        if (!parsedExercises || parsedExercises.length === 0) {
          alert("인식된 운동이 없습니다.\n형식을 다시 한 번 확인해주세요.\n예) 가슴 / 벤치프레스 / 60x10; 60x8; 50x12");
          return;
        }

        // 기존 오늘 루틴에 추가(누적) 방식
        todayExercises = todayExercises.concat(parsedExercises);
        renderTodayExercises();

        alert(parsedExercises.length + "개의 운동이 오늘 루틴에 추가되었습니다.\n3번 영역을 확인해주세요.");
      });
    }

    // 텍스트 지우기
    if (bulkTextClearBtn) {
      bulkTextClearBtn.addEventListener("click", () => {
        bulkTextInput.value = "";
      });
    }

    addExerciseBtn.addEventListener("click", () => {
      const ex = collectCurrentExercise();
      if (!ex) return;
      todayExercises.push(ex);
      renderTodayExercises();
      bodyPartSelect.value = "";
      exerciseNameInput.value = "";
      exercisePresetSelect.innerHTML = `<option value="">부위 선택 후 운동 선택</option>`;
      lastHintDiv.textContent = "";
      resetSets();
    });

    // 레벨 계산 (운동 횟수 기준)
    function getMemberLevel(memberId) {
      const sessions = loadSessions();
      const count = sessions.filter(s => String(s.memberId || "") === String(memberId)).length;
      if (count === 0) return "Lv0-신규";
      if (count <= 3)  return "Lv1-입문";
      if (count <= 12) return "Lv2-초급";
      if (count <= 30) return "Lv3-중급";
      return "Lv4-상급";
    }

    saveSessionBtn.addEventListener("click", () => {
      const memberId = memberSelect.value;
      if (!memberId) {
        alert("먼저 1번에서 회원을 선택해주세요.");
        return;
      }
      if (todayExercises.length === 0) {
        alert("3번에서 오늘 루틴에 추가된 운동이 없습니다.");
        return;
      }
      const member = findMemberById(memberId);
      const memberName = member ? member.name : "(알수없음)";
      const sessions = loadSessions();
      const now = new Date();
      const session = {
        id: Date.now(),
        timestamp: now.getTime(),
        memberId: memberId,
        name: memberName,
        exercises: todayExercises,
      };
      sessions.push(session);
      saveSessions(sessions);
      saveAutoBackup();

      alert("오늘 운동 기록이 저장되었습니다.");
      todayExercises = [];
      renderTodayExercises();
      bodyPartSelect.value = "";
      exerciseNameInput.value = "";
      exercisePresetSelect.innerHTML = `<option value="">부위 선택 후 운동 선택</option>`;
      lastHintDiv.textContent = "";
      resetSets();
      renderSessions();
      renderDashboard();
    });

    // ====== 기록 조회 / CSV ======
    function renderSessions() {
      const sessions = loadSessions().slice().sort((a, b) => b.timestamp - a.timestamp);
      const filterMemberId = searchMemberSelect.value;
      const dateFrom = dateFromInput.value;
      const dateTo   = dateToInput.value;
      sessionsTbody.innerHTML = "";

      sessions.forEach(session => {
        if (filterMemberId && String(session.memberId || "") !== String(filterMemberId)) return;
        const d = new Date(session.timestamp);
        const yyyy_mm_dd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        if (dateFrom && yyyy_mm_dd < dateFrom) return;
        if (dateTo && yyyy_mm_dd > dateTo) return;

        const tr = document.createElement("tr");
        const dateStr = `${yyyy_mm_dd} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
        const member = findMemberById(session.memberId);
        const nameLabel = member
          ? `${member.name} (${member.phone || "전화번호 없음"})`
          : session.name || "(이름 정보 없음)";

        const exText = session.exercises
          .map(ex => {
            const setsText = ex.sets
              .map(s => `${s.setNo}세트: ${s.weight}kg x ${s.reps}회`)
              .join("<br />");
            return `<span class="tag">${ex.bodyPart}</span> <strong>${ex.exerciseName}</strong><br />${setsText}`;
          })
          .join("<br /><br />");

        tr.innerHTML = `
          <td>${dateStr}</td>
          <td>${nameLabel}</td>
          <td style="text-align:left;">${exText}</td>
        `;
        sessionsTbody.appendChild(tr);
      });
    }

    filterBtn.addEventListener("click", renderSessions);
    resetFilterBtn.addEventListener("click", () => {
      searchMemberSelect.value = "";
      dateFromInput.value = "";
      dateToInput.value = "";
      renderSessions();
    });

    // 엑셀용 CSV (UTF-8 BOM 포함)
    function exportToCsv() {
      const sessions = loadSessions();
      if (sessions.length === 0) {
        alert("저장된 기록이 없습니다.");
        return;
      }
      let csv = "날짜시간,회원ID,이름,부위,운동명,세트번호,무게(kg),횟수(회)\n";
      sessions.forEach(session => {
        const d = new Date(session.timestamp);
        const dateStr =
          `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ` +
          `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
        const member = findMemberById(session.memberId);
        const name   = member ? member.name : (session.name || "");
        const memberId = session.memberId || "";
        session.exercises.forEach(ex => {
          ex.sets.forEach(s => {
            const row = [
              dateStr,
              memberId,
              name,
              ex.bodyPart,
              ex.exerciseName,
              s.setNo,
              s.weight,
              s.reps
            ].map(v => `"${String(v).replace(/"/g,'""')}"`).join(",");
            csv += row + "\n";
          });
        });
      });
      const BOM = "\uFEFF";
      const blob = new Blob([BOM + csv], { type: "text/csv;charset=utf-8;" });
      const url  = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const now  = new Date();
      const yyyymmdd = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}`;
      link.href = url;
      link.download = `workout_logs_${yyyymmdd}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    exportCsvBtn.addEventListener("click", exportToCsv);

    // ====== 그룹 운동표 ======




    function renderGroupMembers() {
      groupMemberTags.innerHTML = "";
      groupMembers.forEach((memberId, idx) => {
        const m = findMemberById(memberId);
        if (!m) return;
        const span = document.createElement("span");
        span.className = "member-tag-mini";
        const level = getMemberLevel(memberId);
        span.innerHTML = `${m.name} <span class="small">[${level}]</span> <span data-idx="${idx}" style="cursor:pointer;color:#ef4444;font-weight:bold;">×</span>`;
        groupMemberTags.appendChild(span);
      });

      groupMemberTags.querySelectorAll("span span[data-idx]").forEach(btn => {
        btn.addEventListener("click", () => {
          const index = Number(btn.getAttribute("data-idx"));
          groupMembers.splice(index, 1);
          renderGroupMembers();
        });
      });
    }

    addGroupMemberBtn.addEventListener("click", () => {
      const memberId = groupMemberSelect.value;
      if (!memberId) {
        alert("그룹에 추가할 회원을 선택해주세요.");
        return;
      }
      if (groupMembers.includes(memberId)) {
        alert("이미 그룹에 추가된 회원입니다.");
        return;
      }
      if (groupMembers.length >= 4) {
        alert("그룹은 최대 4명까지 가능합니다.");
        return;
      }
      groupMembers.push(memberId);
      renderGroupMembers();
    });

    function generateGroupTable() {
      if (groupMembers.length === 0) {
        alert("먼저 그룹 회원을 1명 이상 추가해주세요.");
        return;
      }
      if (todayExercises.length === 0) {
        alert("3번에서 오늘 루틴에 운동을 추가한 뒤 사용해주세요.");
        return;
      }
      groupTableHead.innerHTML = "";
      groupTableTbody.innerHTML = "";

      const headerRow1 = document.createElement("tr");
      const headerRow2 = document.createElement("tr");
      headerRow1.innerHTML = `<th rowspan="2">운동명(부위)</th><th rowspan="2">세트</th>`;

      groupMembers.forEach(memberId => {
        const m = findMemberById(memberId);
        if (!m) return;
        const th = document.createElement("th");
        th.colSpan = 2;
        const level = getMemberLevel(memberId);
        th.textContent = `${m.name} (${level})`;
        headerRow1.appendChild(th);

        const thW = document.createElement("th");
        thW.textContent = "무게(kg)";
        const thR = document.createElement("th");
        thR.textContent = "횟수";
        headerRow2.appendChild(thW);
        headerRow2.appendChild(thR);
      });

      groupTableHead.appendChild(headerRow1);
      groupTableHead.appendChild(headerRow2);

      todayExercises.forEach(ex => {
        ex.sets.forEach(s => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.innerHTML = `${ex.exerciseName}<br/><span class="small">[${ex.bodyPart}]</span>`;
          tr.appendChild(tdName);

          const tdSet = document.createElement("td");
          tdSet.textContent = `${s.setNo}세트`;
          tr.appendChild(tdSet);

          groupMembers.forEach(memberId => {
            const lastEx = getLastExerciseHistory(memberId, ex.exerciseName);
            let placeholderWeight = "";
            if (lastEx && lastEx.sets && lastEx.sets.length > 0) {
              const sameSet = lastEx.sets.find(ls => ls.setNo === s.setNo);
              if (sameSet) placeholderWeight = sameSet.weight;
              else placeholderWeight = lastEx.sets[lastEx.sets.length - 1].weight;
            }

            const tdW = document.createElement("td");
            const inputW = document.createElement("input");
            inputW.type = "number";
            inputW.step = "0.5";
            inputW.style.width = "70px";
            inputW.style.textAlign = "center";
            if (placeholderWeight) inputW.placeholder = placeholderWeight;
            tdW.appendChild(inputW);

            const tdR = document.createElement("td");
            const inputR = document.createElement("input");
            inputR.type = "number";
            inputR.step = "1";
            inputR.style.width = "70px";
            inputR.style.textAlign = "center";
            tdR.appendChild(inputR);

            tr.appendChild(tdW);
            tr.appendChild(tdR);
          });

          groupTableTbody.appendChild(tr);
        });
      });
    }

    generateGroupTableBtn.addEventListener("click", generateGroupTable);
    printGroupBtn.addEventListener("click", () => window.print());

    // ====== 인바디 관리 ======
    function renderInbodyForMember(memberId) {
      const records = loadInbody()
        .filter(r => String(r.memberId) === String(memberId))
        .sort((a, b) => (a.date || "").localeCompare(b.date || ""));

      inbodyTbody.innerHTML = "";
      records.forEach(rec => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${rec.date || "-"}</td>
          <td>${rec.weight || "-"}</td>
          <td>${rec.muscle || "-"}</td>
          <td>${rec.fatPercent || "-"}</td>
          <td>${rec.fatMass || "-"}</td>
          <td>${rec.memo || ""}</td>
          <td><button type="button" class="btn-danger inbodyDeleteBtn" data-id="${rec.id}">삭제</button></td>
        `;
        inbodyTbody.appendChild(tr);
      });

      inbodyTbody.querySelectorAll(".inbodyDeleteBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          let list = loadInbody();
          list = list.filter(r => String(r.id) !== String(id));
          saveInbody(list);
          renderInbodyForMember(memberId);
          renderDashboard();
        });
      });
    }

    addInbodyBtn.addEventListener("click", () => {
      const memberId = inbodyMemberSelect.value || memberSelect.value;
      if (!memberId) {
        alert("인바디를 기록할 회원을 선택해주세요.");
        return;
      }
      const date = inbodyDateInput.value;
      if (!date) {
        alert("기록일을 입력해주세요.");
        return;
      }
      const weight = inbodyWeightInput.value.trim();
      const muscle = inbodyMuscleInput.value.trim();
      const fatP   = inbodyFatPercentInput.value.trim();
      const fatM   = inbodyFatMassInput.value.trim();
      const memo   = inbodyMemoInput.value.trim();

      const records = loadInbody();
      records.push({
        id: Date.now(),
        memberId: memberId,
        date,
        weight,
        muscle,
        fatPercent: fatP,
        fatMass: fatM,
        memo
      });
      saveInbody(records);
      saveAutoBackup();

      inbodyDateInput.value = "";
      inbodyWeightInput.value = "";
      inbodyMuscleInput.value = "";
      inbodyFatPercentInput.value = "";
      inbodyFatMassInput.value = "";
      inbodyMemoInput.value = "";

      inbodyMemberSelect.value = memberId;
      renderInbodyForMember(memberId);
      renderDashboard();
      alert("인바디 기록이 추가되었습니다.");
    });

    inbodyMemberSelect.addEventListener("change", () => {
      renderInbodyForMember(inbodyMemberSelect.value || "");
    });

    inbodyFileInput.addEventListener("change", () => {
      const file = inbodyFileInput.files[0];
      if (!file) return;
      const memberId = inbodyMemberSelect.value || memberSelect.value;
      if (!memberId) {
        alert("먼저 인바디를 적용할 회원을 선택해주세요.");
        inbodyFileInput.value = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
          const records = loadInbody();
          let added = 0;
          for (const line of lines) {
            const cols = line.split(",").map(c => c.trim());
            if (cols.length < 5) continue;
            const [date, weight, muscle, fatP, fatM] = cols;
            if (!date) continue;
            records.push({
              id: Date.now() + Math.random(),
              memberId: memberId,
              date,
              weight,
              muscle,
              fatPercent: fatP,
              fatMass: fatM,
              memo: ""
            });
            added++;
          }
          saveInbody(records);
          saveAutoBackup();
          inbodyMemberSelect.value = memberId;
          renderInbodyForMember(memberId);
          renderDashboard();
          alert(`CSV에서 ${added}건의 인바디 기록을 가져왔습니다.`);
        } catch (err) {
          console.error(err);
          alert("CSV 파일을 읽는 중 오류가 발생했습니다.");
        } finally {
          inbodyFileInput.value = "";
        }
      };
      reader.readAsText(file, "utf-8");
    });

    // ====== 대시보드 ======
    function getInbodyRecordsForMember(memberId) {
      return loadInbody()
        .filter(r => String(r.memberId) === String(memberId))
        .sort((a, b) => (a.date || "").localeCompare(b.date || ""));
    }

    function computeMemberWorkoutStats(memberId) {
      const sessions = loadSessions().filter(s => String(s.memberId) === String(memberId));
      let totalSessions = sessions.length;
      let totalSets = 0;
      let totalReps = 0;
      let totalVolume = 0;
      let lastDate = null;
      const perDayVolume = {};

      sessions.forEach(session => {
        const d = new Date(session.timestamp);
        const dayStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        if (!perDayVolume[dayStr]) perDayVolume[dayStr] = 0;

        session.exercises.forEach(ex => {
          ex.sets.forEach(s => {
            const w = parseFloat(s.weight || "0") || 0;
            const r = parseFloat(s.reps || "0") || 0;
            totalSets += 1;
            totalReps += r;
            const vol = w * r;
            totalVolume += vol;
            perDayVolume[dayStr] += vol;
          });
        });

        if (!lastDate || d.getTime() > lastDate.getTime()) {
          lastDate = d;
        }
      });

      // 운동명별 볼륨
      const exVolumeMap = {};
      sessions.forEach(session => {
        session.exercises.forEach(ex => {
          let vol = 0;
          ex.sets.forEach(s => {
            const w = parseFloat(s.weight || "0") || 0;
            const r = parseFloat(s.reps || "0") || 0;
            vol += w * r;
          });
          exVolumeMap[ex.exerciseName] = (exVolumeMap[ex.exerciseName] || 0) + vol;
        });
      });
      const exVolumeArray = Object.entries(exVolumeMap)
        .map(([name, vol]) => ({ name, vol }))
        .sort((a, b) => b.vol - a.vol);

      return {
        totalSessions,
        totalSets,
        totalReps,
        totalVolume,
        lastDate,
        perDayVolume,
        exVolumeArray
      };
    }

    function renderDashboard() {
      const memberId = memberSelect.value;
      if (!memberId) {
        dashboardSummaryDiv.textContent = "1번에서 회원을 선택하면, 운동량/기록/인바디 추이를 한눈에 볼 수 있습니다.";
        dashboardVolumeDiv.innerHTML = "";
        dashboardInbodyDiv.innerHTML = "";
        return;
      }
      const member = findMemberById(memberId);
      if (!member) {
        dashboardSummaryDiv.textContent = "선택된 회원 정보가 없습니다.";
        dashboardVolumeDiv.innerHTML = "";
        dashboardInbodyDiv.innerHTML = "";
        return;
      }

      const stats = computeMemberWorkoutStats(memberId);
      const level = getMemberLevel(memberId);

      // 요약 카드
      const lastDateStr = stats.lastDate
        ? `${stats.lastDate.getFullYear()}-${String(stats.lastDate.getMonth()+1).padStart(2,"0")}-${String(stats.lastDate.getDate()).padStart(2,"0")}`
        : "-";
      const avgVolumePerSession = stats.totalSessions
        ? Math.round(stats.totalVolume / stats.totalSessions)
        : 0;

      dashboardSummaryDiv.innerHTML = `
        <div class="dashboard-grid">
          <div class="dashboard-card">
            <strong>${member.name}</strong><br/>
            레벨: ${level}<br/>
            성별: ${member.gender || "-"} / 키: ${member.height ? member.height + "cm" : "-"}<br/>
            최근 운동일: ${lastDateStr}
          </div>
          <div class="dashboard-card">
            <strong>운동 누적 통계</strong><br/>
            총 운동 횟수: ${stats.totalSessions}회<br/>
            총 세트 수: ${stats.totalSets}세트 / 총 반복수: ${stats.totalReps}회<br/>
            총 볼륨: ${Math.round(stats.totalVolume)} kg<br/>
            회당 평균 볼륨: ${avgVolumePerSession} kg
          </div>
          <div class="dashboard-card">
            <strong>자주 하는 운동 TOP3 (볼륨 기준)</strong><br/>
            ${
              stats.exVolumeArray.length === 0
                ? "운동 기록이 없습니다."
                : stats.exVolumeArray.slice(0,3).map((ex, idx) =>
                    `${idx+1}. ${ex.name} - ${Math.round(ex.vol)} kg`
                  ).join("<br/>")
            }
          </div>
        </div>
      `;

      // 날짜별 볼륨 바 차트
      const volEntries = Object.entries(stats.perDayVolume).sort((a,b) => a[0].localeCompare(b[0]));
      if (volEntries.length === 0) {
        dashboardVolumeDiv.innerHTML = `<div class="small">아직 저장된 운동 기록이 없어 날짜별 볼륨을 표시할 수 없습니다.</div>`;
      } else {
        const maxVol = volEntries.reduce((max, [, v]) => Math.max(max, v), 0) || 1;
        const rowsHtml = volEntries.map(([date, vol]) => {
          const pct = Math.max(5, Math.round(vol / maxVol * 100)); // 최소 5%
          return `
            <div class="volume-row">
              <div style="width:90px;">${date}</div>
              <div class="volume-bar-container">
                <div class="volume-bar" style="width:${pct}%;"></div>
              </div>
              <div style="width:70px; text-align:right;">${Math.round(vol)} kg</div>
            </div>
          `;
        }).join("");
        dashboardVolumeDiv.innerHTML = `
          <div class="small" style="margin-bottom:4px;"><strong>날짜별 총 볼륨</strong></div>
          ${rowsHtml}
        `;
      }

      // 인바디 요약
      const inbodyRecs = getInbodyRecordsForMember(memberId);
      if (inbodyRecs.length === 0) {
        dashboardInbodyDiv.innerHTML = `<div class="small"><strong>인바디</strong> 기록이 없습니다. 7번 인바디 관리에서 기록을 추가해주세요.</div>`;
      } else {
        const first = inbodyRecs[0];
        const last  = inbodyRecs[inbodyRecs.length - 1];

        const w1 = parseFloat(first.weight || "0") || 0;
        const w2 = parseFloat(last.weight || "0") || 0;
        const m1 = parseFloat(first.muscle || "0") || 0;
        const m2 = parseFloat(last.muscle || "0") || 0;
        const f1 = parseFloat(first.fatPercent || "0") || 0;
        const f2 = parseFloat(last.fatPercent || "0") || 0;

        const dw = (w2 - w1).toFixed(1);
        const dm = (m2 - m1).toFixed(1);
        const df = (f2 - f1).toFixed(1);

        const recentRows = inbodyRecs.slice(-5).reverse().map(r => `
          <tr>
            <td>${r.date || "-"}</td>
            <td>${r.weight || "-"}</td>
            <td>${r.muscle || "-"}</td>
            <td>${r.fatPercent || "-"}</td>
            <td>${r.fatMass || "-"}</td>
          </tr>
        `).join("");

        dashboardInbodyDiv.innerHTML = `
          <div class="dashboard-card">
            <strong>인바디 추이 요약</strong><br/>
            기준: ${first.date || "-"} → 최신: ${last.date || "-"}<br/>
            체중: ${w1.toFixed(1)} → ${w2.toFixed(1)} kg (${dw >= 0 ? "+"+dw : dw} kg)<br/>
            골격근량: ${m1.toFixed(1)} → ${m2.toFixed(1)} kg (${dm >= 0 ? "+"+dm : dm} kg)<br/>
            체지방률: ${f1.toFixed(1)} → ${f2.toFixed(1)} % (${df >= 0 ? "+"+df : df} %)
          </div>
          <div class="small" style="margin-top:6px;"><strong>최근 인바디 기록 (최대 5개)</strong></div>
          <table>
            <thead>
              <tr>
                <th>날짜</th>
                <th>체중</th>
                <th>골격근량</th>
                <th>체지방률</th>
                <th>체지방량</th>
              </tr>
            </thead>
            <tbody>
              ${recentRows}
            </tbody>
          </table>
        `;
      }
    }

    // ====== 초기 실행 ======
    renderMembersTable();
    renderMemberSelectOptions();
    renderSessions();
    updateBackupInfo();
    initAutoDownloadToggle();

    // 운동 라이브러리 관리 초기 상태
    libBodyPartSelect.value = "가슴";
    renderLibExerciseList();
    populateExercisePreset();

    // 인바디 초기 렌더 (기본 선택 X)
    renderInbodyForMember("");
  </script>
<!-- 🔥 AI 챗봇 UI (우측 하단) -->
<style>
#aiChatButton {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: #2563eb;
  border-radius: 50%;
  width: 58px;
  height: 58px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: white;
  font-size: 26px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.28);
  z-index: 999;
}
#aiChatWindow {
  position: fixed;
  bottom: 96px;
  right: 24px;
  width: 360px;
  max-height: 540px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.32);
  display: none;
  flex-direction: column;
  overflow: hidden;
  z-index: 9999;
}
#aiChatHeader {
  padding: 12px;
  background: #1e3a8a;
  color: white;
  font-size: 15px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
#aiChatMessages {
  padding: 12px;
  flex: 1;
  overflow-y: auto;
  font-size: 14px;
}
.aiMsg {
  margin-bottom: 12px;
  line-height: 1.4;
}
.aiMe { text-align: right; color: #2563eb; font-weight: 600; }
.aiBot { text-align: left; }
#aiChatInputArea {
  display: flex;
  border-top: 1px solid #ddd;
}
#aiChatInput {
  flex: 1;
  resize: none;
  padding: 8px;
  border: none;
  font-size: 14px;
  outline: none;
}
#aiChatSend {
  width: 70px;
  background: #2563eb;
  border: none;
  color: white;
  cursor: pointer;
  font-weight: 600;
}
</style>

<div id="aiChatButton">💬</div>

<div id="aiChatWindow">
  <div id="aiChatHeader">
    AI 운동 분석 챗봇
    <span id="aiChatClose" style="cursor:pointer;">✖</span>
  </div>
  <div id="aiChatMessages"></div>
  <div id="aiChatInputArea">
    <textarea id="aiChatInput" rows="1" placeholder="메시지를 입력..."></textarea>
    <button id="aiChatSend">전송</button>
  </div>
</div>

<script>
 <script>
  // ====== 열기 / 닫기 ======
  document.getElementById("aiChatButton").onclick = () => {
    document.getElementById("aiChatWindow").style.display = "flex";
  };
  document.getElementById("aiChatClose").onclick = () => {
    document.getElementById("aiChatWindow").style.display = "none";
  };

  // ====== 말풍선 출력 ======
  function aiAddMessage(text, sender = "bot") {
    const box = document.getElementById("aiChatMessages");
    const div = document.createElement("div");
    div.className = "aiMsg " + (sender === "me" ? "aiMe" : "aiBot");
    div.innerHTML = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  // ====== Netlify Functions로 요청 보내기 ======
  async function aiSendToServer(msg) {
    try {
      const memberId = window.memberSelect?.value || "";
      const payload = {
        message: msg,
        memberId,
        members: loadMembers(),
        sessions: loadSessions(),
        inbody: loadInbody(),
        exerciseLibrary
      };

      const res = await fetch("/.netlify/functions/ai-chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      // HTTP 에러 코드 처리
      if (!res.ok) {
        aiAddMessage(`⚠ 서버 오류 (status: ${res.status})`, "bot");
        return;
      }

      const data = await res.json();
      console.log("AI 응답:", data);

      // ✅ text, reply 둘 다 대응
      const replyText =
        data.text ||    // 내가 새로 설계했을 때
        data.reply ||   // 예전 코드에서 쓰던 형식
        data.message || // 혹시 message라는 필드로 올 때
        "";

      if (replyText) {
        aiAddMessage(replyText, "bot");
      } else {
        aiAddMessage("⚠ 서버 응답은 받았지만, 표시할 내용이 없습니다.", "bot");
      }

      // AI가 action 내려줄 경우 처리
      if (data.action) {
        handleAiAction(data.action);
      }

    } catch (e) {
      console.error(e);
      aiAddMessage("⚠️ 서버에 연결할 수 없습니다. (Netlify Functions 설정 확인 필요)", "bot");
    }
  }

  // ====== AI가 내려준 action 처리 ======
  function handleAiAction(action) {
    // 1) 운동 추가
    if (action.addExercises && Array.isArray(action.addExercises)) {
      if (!Array.isArray(window.todayExercises)) {
        window.todayExercises = [];
      }
      window.todayExercises = window.todayExercises.concat(action.addExercises);
      if (typeof renderTodayExercises === "function") {
        renderTodayExercises();
      }
    }

    // 2) 인바디 분석 카드 추가
    if (action.inbodyAnalysis && typeof action.inbodyAnalysis === "string") {
      const dash = document.getElementById("dashboardInbody");
      if (dash) {
        dash.innerHTML += `
          <div class="dashboard-card" style="margin-top:6px;">
            <strong>AI 분석 결과</strong><br/>${action.inbodyAnalysis}
          </div>`;
      }
    }

    // 3) 알림
    if (action.alert) {
      alert(action.alert);
    }
  }

  // ====== 메시지 전송 공통 로직 ======
  function sendMessage() {
    const input = document.getElementById("aiChatInput");
    const msg = input.value.trim();
    if (!msg) return;
    aiAddMessage(msg, "me");
    input.value = "";
    aiSendToServer(msg);
  }

  // 버튼 클릭
  document.getElementById("aiChatSend").onclick = sendMessage;

  // 엔터키 (Shift+Enter는 줄바꿈)
  document.getElementById("aiChatInput").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
</script>
</body>
</html>



